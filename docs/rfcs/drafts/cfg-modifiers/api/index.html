<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-rfcs/drafts/cfg-modifiers/api">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">[RFC] Configuration Modifiers | Buck2</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/rfcs/drafts/cfg-modifiers/api/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[RFC] Configuration Modifiers | Buck2"><meta data-rh="true" name="description" content="Target platform is Buck team&#x27;s endorsed way of supporting custom build"><meta data-rh="true" property="og:description" content="Target platform is Buck team&#x27;s endorsed way of supporting custom build"><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/rfcs/drafts/cfg-modifiers/api/"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/rfcs/drafts/cfg-modifiers/api/" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/rfcs/drafts/cfg-modifiers/api/" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GEGGHE39PE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GEGGHE39PE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.96950b1b.css">
<link rel="preload" href="/assets/js/runtime~main.e94ab9dd.js" as="script">
<link rel="preload" href="/assets/js/main.71de8834.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Buck2</b></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/docs/api/rules/">Rules</a><a class="navbar__item navbar__link" href="/docs/api/">API</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>[RFC]<!-- --> Configuration Modifiers</h1><p>Target platform is Buck team&#x27;s endorsed way of supporting custom build
settings, and it&#x27;s intended to replace the buckconfigs and modefiles of
buckconfigs widely used today. Buckconfigs are bad because they are
global flags, and changing them can cause invalidation of most if not
all of Buck&#x27;s state, whereas target platforms/configurations are
per-target build settings and allow for scalable multi-configuration
builds like building in multiple settings (ex. dev and opt) concurrently
or modifying the configuration within the dependency graph. However,
despite improvements to configurations in Buck2, buckconfigs continue to
be the predominant way of representing build settings, and they are not
losing popularity - almost all build settings in the repo today have
some sort of buckconfig toggle. This means that users often hit
invalidation overhead from buck2 when switching modefiles or
buckconfigs.</p><p>When comparing buckconfigs and target platforms, the biggest usability
problem with target platforms is that <strong>they do not compose well</strong>.</p><ol><li><p><em>Using target platforms require generating all possible permutations
of build settings</em>. As an example, say I want to customize targets
based on different OSes (linux, mac, or windows), sanitizers (asan,
tsan, or nosan), and link style (static or shared). With target
platforms, I need to first generate all possible permutations of
these settings as platform targets before I can use them. For this
example, I would need 18 different platforms: linux-asan-static,
linux-asan-shared, linux-tsan-static, linux-tsan-shared, so on and so
forth. The exponential nature of platform generation makes it
challenging to add a new constraint because you could double the
number of platforms. Buckconfigs don&#x27;t have this problem because OS,
sanitizer, and link style can be separate buckconfigs and you do not
have to generate all possible combinations to use them.</p></li><li><p><em>Setting a default target platform is complex.</em> Setting a default
target platform for a target requires knowing the exact set of build
settings needed and the exact platform corresponding to those
settings. Because a lot of build defaults are defined in bzl files,
this often ends up getting handled by a set of fairly convoluted bzl
files many hundreds of lines long. For example, suppose python
library <code>root//:foo</code> prefers the default settings of mac, asan, and
static. The python library macros must gather those settings at once
and map them to the platform name <code>mac-asan-static</code>. Setting a
buckconfig as default is as easy as adding the buckconfig value to
.buckconfig file or a modefile.</p></li><li><p><em>You must specify a full target platform on the command line
for <code>--target-platforms</code> flag</em>. Despite all the convoluted macros
needed to set a <code>default_target_platform</code>, they become useless when
you don&#x27;t want the default because you have to specify a <strong>full</strong>
target platform on the command line. Following the previous example,
suppose <code>repo//:foo</code> defaults to nosan but I want to
build <code>repo//:foo</code> with asan. For target platform, I have to know
what OS and link style to build <code>//:foo</code> with as well so I can
specify <code>buck2 build //:foo --target-platforms=:&lt;os&gt;-asan-&lt;link style&gt;</code>
to build <code>//:foo</code> with asan. It&#x27;s impossible to specify &quot;I just want
asan on top of the defaults&quot; with <code>--target-platforms</code>. Buckconfigs
don&#x27;t have this problem because they can compose on the command line
via the <code>--config</code> flag.</p></li><li><p><em>Target platforms are difficult to understand.</em>
Most users can easily grasp how buckconfigs work because it&#x27;s easy to
set and read them. Very few understand how configurations work
because of how complex target platform resolution is. Instead, it
would be much simpler if constraints like OS and sanitizers can be
set directly on the command line, similar to how buckconfigs are set.</p></li></ol><p>This RFC proposes a new configuration API that is simpler and easier to
use than target platforms. The API is composition-first and avoids the
exponential permutation generation of platforms. The goal of this API is
to enable the migration of buckconfigs to configurations and make build
setting easy for users to use.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="api">API<a href="#api" class="hash-link" aria-label="Direct link to API" title="Direct link to API">​</a></h2><p>A configuration is a collection of constraints.</p><p>In this API, every top-level target starts with an empty configuration.
To resolve the default target configuration, Buck will apply a list of
&quot;modifiers&quot;. A modifier is a modification on the existing configuration
to obtain a new configuration.</p><p>A modifier can be applied on the command line, on a PACKAGE, or on a
target. When resolving modifiers, Buck will collect all modifiers from
command line, PACKAGE, and target and apply them in order until the
target configuration is obtained.</p><p>A modifier can be specified as a <code>constraint_value</code>, a <code>config_setting</code>,
<code>platform</code>, or a <code>cfg_override</code> target. If the modifier applied
is a constraint value, that constraint value will be added to the
configuration. Config setting and platform are both collections of
constraints, so if the modifier is a config setting or a platform, then
we loop over every constraint value and add it to the configuration
(note that since modifiers only work with configuration and not
buckconfigs, using a <code>config_setting</code> with a non-empty set of
buckconfigs as a modifier will be an error).
<code>cfg_override</code> rule applies a transition-like function
that can arbitrarily insert or delete constraints
from the existing configuration.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-required-modifiers">1. Required Modifiers<a href="#1-required-modifiers" class="hash-link" aria-label="Direct link to 1. Required Modifiers" title="Direct link to 1. Required Modifiers">​</a></h3><p>Every top-level target starts with an empty configuration.
Buck first applies &quot;required modifiers&quot;, which is a list of modifiers
provided by the user via the command line.
The required modifiers are specified as
<code>buck2 build &lt;target&gt;?&lt;modifiers separated by commas&gt;</code>,
and the list of modifiers will be applied sequentially in that order.</p><p>For example,</p><ul><li>If the user requests <code>buck2 build //foo:bar</code>, <code>repo//foo:bar</code> will
have an empty configuration after resolving the required modifiers.</li><li>If the user requests
<code>buck2 build repo//foo:bar?config//build_mode/constraints:nosan</code>,
<code>repo//foo:bar</code> will have <code>config//build_mode/constraints:nosan</code>
in its configuration after resolving required modifiers.</li><li><code>buck2 build repo//foo:bar?config//build_mode/constraints:nosan,config//build_mode/constraints:split-dwarf</code>
will add nosan and split-dwarf in that order to the empty
configuration.</li><li>If the user requests
<code>buck2 build repo//foo:bar?config//build_mode/constraints:nosan,config//build_mode/constraints:asan</code>
where both constraint values belong to the same constraint
<code>config//build_mode/constraints:san</code>,
then asan will replace nosan in <code>repo//foo:bar</code>&#x27;s configuration.</li></ul><p>To make constraints more convenient to type, you can use Buck&#x27;s
target alias feature to create an alias for a constraint.
For example, you can add the following line to your .buckconfig</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[alias]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  asan = config//build_mode/constraints:asan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nosan = config//build_mode/constraints:nosan</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>to use <code>buck2 build repo//foo:bar?asan</code> and <code>buck2 build repo//foo:bar?nosan</code> as shorthand.</p><p><code>buck2 build repo//foo/...?asan</code> and <code>buck2 build repo//foo:?asan</code>
are both valid.</p><p>To specify modifiers to a list of target patterns on the command line,
you can use the <code>--cfg=modifier</code> flag.
For example, <code>buck2 build //foo:bar //foo:baz --cfg=asan</code>
is equivalent to <code>buck2 build repo//foo:bar?asan //foo:baz?asan</code>.</p><p><code>--cfg</code> flag can be specified multiple times to add multiple modifiers.
For example, <code>buck2 build --cfg=release --cfg=windows repo//foo:bar</code>
is equivalent to <code>buck2 build repo//foo:bar?release,windows</code>.
This behavior is consistent with how flags are interpreted
in other tools, and it is the most intuitive behavior, for example,</p><ul><li>buckconfig <code>-c</code> flag adds to the one set of buckconfigs</li><li>build systems like CMake have flags like <code>-D</code> that can be specified
multiple times, and they are all added to one set of flags.</li></ul><p>It is prohibited to specify both <code>--cfg</code> flag and <code>?</code> in target pattern.
<code>--cfg</code> flag exists for convenience, and to specify
complex configuration setups (in scripts or in CI),
users can always specify <code>?</code>.
This restriction can be lifted in the future if there is a need.</p><p>When specifying a subtarget and modifier with <code>?</code>,
subtarget should go before modifier,
ex. <code>buck2 build repo//foo:bar[comp-db]?asan</code>.</p><p>The configuration after all required modifiers are resolved is known as
required configuration, and all constraints within that configuration
are immutable entries of the target configuration. They cannot be
removed or overwritten. This guarantees that the configuration a target
ends up with always include the modifiers user requested.</p><p>For example, if the user requests asan on the command line, the target
configuration should always end up with an asan constraint value, not a
nosan constraint value. If a later PACKAGE or per-target modifier
specifies nosan as a constraint, nosan will not be added to the
configuration because asan and nosan both belong to the same
constraint <code>config//build_mode/constraints:sanitizer</code>, and asan is a
required constraint.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-legacy-target-platform">2. (Legacy) Target platform<a href="#2-legacy-target-platform" class="hash-link" aria-label="Direct link to 2. (Legacy) Target platform" title="Direct link to 2. (Legacy) Target platform">​</a></h3><p>If a target platform is specified on a target
(either via the <code>default_target_platform</code> attribute
or the <code>--target-platforms</code> flag), then that target platform
gets applied as a modifier, where Buck loops over every constraint
within the platform and add it to the target configuration
unless that constraint conflicts with the required configuration.</p><p>When required, PACKAGE, and target modifiers are empty,
the target configuration is the target platform.
This is designed to making the new API interop
with target platform resolution so that the migration
can be gradual.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-per-package-modifiers">3. Per-PACKAGE modifiers<a href="#3-per-package-modifiers" class="hash-link" aria-label="Direct link to 3. Per-PACKAGE modifiers" title="Direct link to 3. Per-PACKAGE modifiers">​</a></h3><p>Per-PACKAGE modifiers are applied after target platform is resolved.</p><p>To define a per-PACKAGE modifier, you can use the
<code>add_default_cfg(&lt;modifier&gt;)</code> function in a PACKAGE file.
A modifier set through <code>add_default_cfg</code> will apply to
all targets covered by that PACKAGE.</p><p>The following example adds nosan and debug to the default target
configurations of all targets in <code>repo//foo/...</code> unless the required
configuration already has conflicting required constraints.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># foo/PACKAGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_default_cfg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;config//build_mode/constraints:nosan&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_default_cfg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;config//build_mode/constraints:debug&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this example, debug is applied after nosan.</p><p>If a sub-PACKAGE exists for a PACKAGE, that sub-PACKAGE
will always inherit modifiers from its parent.
This means that if there are multiple PACKAGE files in the path
of a target, we apply their modifiers in order from the topmost PACKAGE.</p><p>Suppose <code>repo/PACKAGE</code> and <code>repo/foo/PACKAGE</code> exist for
target <code>repo//foo:bar</code>. In this case, modifiers in repo/PACKAGE apply
first before modifiers in <code>repo/foo/PACKAGE</code>. PACKAGE inheritance of
modifiers means that project-level modifiers can be easily set for all
targets under a project without having to wire logic through the bzl
wrapper of every rule type in that project.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-per-target-modifier">4. Per-Target Modifier<a href="#4-per-target-modifier" class="hash-link" aria-label="Direct link to 4. Per-Target Modifier" title="Direct link to 4. Per-Target Modifier">​</a></h3><p>Per-target modifier are applied after all per-PACKAGE modifier
are resolved.</p><p>Modifiers can be set on any target through the <code>default_cfg</code> attribute.
The modifiers are specified as a list and will be applied
in sequential order.</p><p>For example,</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># repo/foo/TARGETS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python_binary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Some other attributes...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_cfg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;config//build_mode/constraints:nosan&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;config//build_mode/constraints:debug&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>adds nosan and debug constraints in that order to
<code>repo//foo:bar</code>&#x27;s configuration.</p><p>Once per-target modifiers are resolved, we end up
with a target configuration used to configure a target.</p><p>Note that that target&#x27;s configuration can further change after modifiers
are resolved if there are per-rule transitions applied on the target.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cfg_override-rule"><code>cfg_override</code> rule<a href="#cfg_override-rule" class="hash-link" aria-label="Direct link to cfg_override-rule" title="Direct link to cfg_override-rule">​</a></h3><p>A modifier can be defined as a <code>cfg_override</code> rule in addition
to platform and constraint value. This rule applies a function
that takes in the existing configuration as input, changes it,
and returns a new configuration.</p><p>This allows more complex logic like adding a constraint only if
an existing constraint exists.</p><p>The following example shows a way to express &quot;use msvc on windows
configuration but clang on other OSes&quot;.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># repo/BUCK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_msvc_if_windows_else_clang_impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># `Configuration` is an opaque object that supports methods `contains`, `get`, `insert`, and `pop` similar to a dictionary.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cfg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Configuration&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># `Refs` holds references to dependent constraints, platforms, and modifiers.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  refs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Configuration&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">refs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">windows</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">refs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msvc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">refs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clang</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfg_override</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;msvc_if_windows_else_clang&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  impl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _msvc_if_windows_else_clang_impl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  refs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;clang&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;config//compiler/constraints:clang&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;msvc&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;config//compiler/constraints:msvc&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;windows&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;config//os/constraints:windows&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># repo/PACKAGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_default_cfg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;:msvc_if_windows_else_clang&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now a target will always have the msvc constraint added
when targeting windows but the clang constraint otherwise.</p><p>It&#x27;s possible to make <code>cfg_override</code> significantly less verbose
via a lambda. For example, the above example can be rewritten as</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># repo/BUCK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfg_override</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;msvc_if_windows_else_clang&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># `cfg.set` returns a `Configuration` object.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  impl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> refs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    refs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msvc </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">refs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">windows</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> refs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  refs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;clang&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;config//compiler/constraints:clang&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;msvc&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;config//compiler/constraints:msvc&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;windows&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;config//os/constraints:windows&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>cfg_override</code> target can only be specified for PACKAGE
and per-target modifiers, not required modifiers
(this restriction can be revisited later if needed).</p><p><code>cfg_override</code> is only intended for complex cases needed
to selectively insert constraints based on existing constraints.
For the majority of use cases, specifying constraints directly
as modifiers should be sufficient.</p><p>Like other types of modifiers, <code>cfg_override</code> cannot override
required constraints.
To guarantee this, <code>insert</code> and <code>pop</code> methods of <code>Configuration</code> object
will be no-ops if it is trying to overwrite a required constraint.</p><p>For example, in the previous example, if the user supplies a requested
configuration of windows and clang, then the target configuration
will end up containing windows and clang, not windows and msvc.</p><p>To make it clear which constraints are required
to the <code>cfg_override</code> function, the <code>Configuration</code> object
supports a <code>required_cfg</code> function that returns
a <code>RequiredConfiguration</code> object holding only the required constraints.
A <code>RequiredConfiguration</code> is immutable and supports
<code>contains</code> and <code>get</code> methods but not <code>insert</code>, <code>set</code>, or <code>pop</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-naming">Configuration Naming<a href="#configuration-naming" class="hash-link" aria-label="Direct link to Configuration Naming" title="Direct link to Configuration Naming">​</a></h3><p>It&#x27;s important for a configuration to have a representative name
to indicate what important constraints were used.
This is useful for debugging because often a build error
is caused by a misconfiguration.</p><p>To make this easy, this API adds a naming function to derive a useful
name based on the existing configuration. The name function takes in a
map of constraint settings to constraint values as input and returns a
string for the name of the configuration. This name function will be
defined globally for a repo.</p><p>An example is as follows.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Generated configuration follows the name &lt;os&gt;-&lt;sanitizer&gt;-&lt;toolchain&gt;.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KEY_CONSTRAINT_SETTINGS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;config//os/constraints:os&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;config//build_mode/constraints:sanitizer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;config//compiler/constraints:toolchain&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Keys and values in `constraints_map` are fully qualified target label strings.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  constraint_map</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># {str.type: str.type}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name_builder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> constraint_setting </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> KEY_CONSTRAINT_SETTINGS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constraint_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> constraint_map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">constraint_setting</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> constraint_value </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Get the target name from full target label and add it to the generated name.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name_builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">constraint_value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name_builder</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="debugging-modifiers">Debugging modifiers<a href="#debugging-modifiers" class="hash-link" aria-label="Direct link to Debugging modifiers" title="Direct link to Debugging modifiers">​</a></h2><p>Because many layers of modifiers can be applied before obtaining
a final configuration, it is important that modifiers are easy
to debug for integrators. To show what modifiers are applied,
we can add a <code>buck.modifiers</code> special attribute to every target
that keeps track of all the required modifiers, legacy target platform,
per-PACKAGE modifiers and per-target modifiers a target goes through
in order. We can also add a <code>buck2 audit cfg-modifiers &lt;TARGET&gt;</code>
command to show the configuration change after each modifier
is applied as well as which PACKAGE/BUCK/TARGETS file
each modifier is added.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-configuration-modifiers-differ-from-transitions">How configuration modifiers differ from transitions<a href="#how-configuration-modifiers-differ-from-transitions" class="hash-link" aria-label="Direct link to How configuration modifiers differ from transitions" title="Direct link to How configuration modifiers differ from transitions">​</a></h2><p>Modifiers are largely inspired by configuration transitions,
and there are a high amount of similarities in particular between
the <code>cfg_override</code> rule and the transition rule.</p><p>The major differences are:</p><ol><li>A transition can change the configuration of a target when depending
on a target, but a modifier can only change the configuration of a
top-level target. In other words, if you have target A that depends
on target B and you request a build of A, then A&#x27;s target
configuration would be resolved via modifiers and propagated down to
B, but dep B would not do its own modifier resolution</li><li><code>cfg_override</code> functions see an opaque &quot;Configuration&quot; object, so it
cannot know every single constraint used in the configuration.
Transition functions can iterate and read every constraint in the
configuration. Transitions can use logic like &quot;throw away the old
configuration entirely and use a new configuration&quot; (which is what
fat platform transition currently does) whereas an override cannot.</li><li>Transitions can accept an <code>attrs</code> parameter from the attributes
of the target if necessary whereas <code>cfg_override</code> does not
(if necessary, this can be revisited).</li><li><code>cfg_override</code> is specified as a target and transition is not.</li></ol><p>Ideally, we should unify all the API differences between <code>cfg_override</code>
and <code>transition</code> and use <code>transition</code> directly instead,
but that&#x27;s out of the scope of this RFC for now.</p><p>They have different use cases. For example,</p><ol><li><em>Python version</em> should be modeled as a transition and not modifier.
Suppose we have <code>python_binary</code> A nested as a resource of
another <code>python_binary</code> B. A should not inherit the python version
from B, so a transition is needed to change A&#x27;s python version
when depended on by B.</li><li><em>Library target</em> should use modifiers and not transitions.
A C++ library target should always inherit the configuration
of its parent C++ binary when it is used as a dep,
but a top-level C++ library target can still have its configuration
changed via modifiers when requested from command line.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="end-goal">End Goal<a href="#end-goal" class="hash-link" aria-label="Direct link to End Goal" title="Direct link to End Goal">​</a></h2><ol><li><p>No more <code>default_target_platform</code>.</p></li><li><p>No more <code>--target-platforms</code> flag.</p></li><li><p>There shouldn&#x27;t be a need to define <code>platform</code> targets
outside of exec platforms.</p></li><li><p>Most use cases of <code>read_config</code> are killed.
Buckconfigs should be reserved for buck2 core features.</p></li><li><p>Most build settings should only use configurations.</p></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#api" class="table-of-contents__link toc-highlight">API</a><ul><li><a href="#1-required-modifiers" class="table-of-contents__link toc-highlight">1. Required Modifiers</a></li><li><a href="#2-legacy-target-platform" class="table-of-contents__link toc-highlight">2. (Legacy) Target platform</a></li><li><a href="#3-per-package-modifiers" class="table-of-contents__link toc-highlight">3. Per-PACKAGE modifiers</a></li><li><a href="#4-per-target-modifier" class="table-of-contents__link toc-highlight">4. Per-Target Modifier</a></li><li><a href="#cfg_override-rule" class="table-of-contents__link toc-highlight"><code>cfg_override</code> rule</a></li><li><a href="#configuration-naming" class="table-of-contents__link toc-highlight">Configuration Naming</a></li></ul></li><li><a href="#debugging-modifiers" class="table-of-contents__link toc-highlight">Debugging modifiers</a></li><li><a href="#how-configuration-modifiers-differ-from-transitions" class="table-of-contents__link toc-highlight">How configuration modifiers differ from transitions</a></li><li><a href="#end-goal" class="table-of-contents__link toc-highlight">End Goal</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">User guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e94ab9dd.js"></script>
<script src="/assets/js/main.71de8834.js"></script>
</body>
</html>