<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-rule_authors/transitive_sets">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Transitive Sets | Buck2</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/rule_authors/transitive_sets/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Transitive Sets | Buck2"><meta data-rh="true" name="description" content="Transitive sets enable the propagation of data up dependency trees in a manner that is both efficient in Starlark code (low cost of creation, low memory usage) and efficient for execution by Buck (edges can be shared instead of having each action depend directly on all its inputs)."><meta data-rh="true" property="og:description" content="Transitive sets enable the propagation of data up dependency trees in a manner that is both efficient in Starlark code (low cost of creation, low memory usage) and efficient for execution by Buck (edges can be shared instead of having each action depend directly on all its inputs)."><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/rule_authors/transitive_sets/"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/rule_authors/transitive_sets/" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/rule_authors/transitive_sets/" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GEGGHE39PE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GEGGHE39PE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.96950b1b.css">
<link rel="preload" href="/assets/js/runtime~main.e94ab9dd.js" as="script">
<link rel="preload" href="/assets/js/main.71de8834.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Buck2</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/api/rules/">Rules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/api/">API</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/why/">About Buck2</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/concepts/concept_map/">Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/users/commands/">Buck2 Users</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/rule_authors/writing_rules/">Rule Authors</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/writing_rules/">Writing Rules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/rule_api/">Rule APIs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/rule_authors/transitive_sets/">Transitive Sets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/configurations/">Configurations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/configuration_transitions/">Configuration Transitions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/dynamic_dependencies/">Dynamic Dependencies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/anon_targets/">Anonymous Targets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/test_execution/">Test Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/optimization/">Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/incremental_actions/">Incremental Actions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/alias/">Alias</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/local_resources/">Local Resources For Tests Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/dep_files/">Dep Files</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/developers/bxl/">BXL Developers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/developers/architecture/buck2/">Buck2 Developers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/api/">API</a><button aria-label="Toggle the collapsible sidebar category &#x27;API&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Rule Authors</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Transitive Sets</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Transitive Sets</h1></header><p>Transitive sets enable the propagation of data up dependency trees in a manner that is both efficient in Starlark code (low cost of creation, low memory usage) and efficient for execution by Buck (edges can be shared instead of having each action depend directly on all its inputs).</p><p>Examples of where transitive sets are useful include:</p><ul><li>Propagating transitive link-time dependencies of a library all the way to a binary to build.</li><li>Propagating transitive compile-time headers.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rule-api">Rule API<a href="#rule-api" class="hash-link" aria-label="Direct link to Rule API" title="Direct link to Rule API">​</a></h2><p>First, you need to declare your transitive set type, then you can use it, as follows:</p><div class="language-starlark codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-starlark codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># This is the type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySet = transitive_set()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Those are transitive sets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set1 = ctx.actions.tset(MySet, value = &quot;foo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set2 = ctx.actions.tset(MySet, value = &quot;bar&quot;, children = [set1])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Values are optional, and so are children. This means you can have a set with no value and sets with no children.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="projections-using-transitive-sets-in-command-lines">Projections: using transitive sets in command lines<a href="#projections-using-transitive-sets-in-command-lines" class="hash-link" aria-label="Direct link to Projections: using transitive sets in command lines" title="Direct link to Projections: using transitive sets in command lines">​</a></h2><p>Sets aren&#x27;t useful unless you can use their contents!</p><p>To use a set in a command line, you use a concept called a &#x27;projection&#x27;, which defines how to turn individual values found in the set into command line arguments.</p><p>To define a projection, you write a function that takes a value of your set and returns a command-line like object (<code>cmd_args</code>, <code>string</code>, <code>attr.arg()</code> attributes, <code>artifact</code>, and so on) or a list of them in whichever way makes sense for your use case.</p><p>Then, you call <code>project_as_args</code> to turn a set into a value suitable for inclusion in a command line. When expanded, this projection will expand like a list of all the node&#x27;s individual projected values.</p><p>Following is an example:</p><div class="language-starlark codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-starlark codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Declare the projection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def project_as_define(value: str.type):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return cmd_args(value, format = &quot;-D{}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add it to the set definition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySet = transitive_set(args_projections = { &quot;define&quot;: project_as_define })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Create a set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set1 = ctx.actions.tset(MySet, value = &quot;foo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set2 = ctx.actions.tset(MySet, value = &quot;bar&quot;, children = [set1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Call the projection.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Note &quot;define&quot; is the key used above in `args_projections`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">args = set2.project_as_args(&quot;define&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When you use <code>args</code> in a command line, it will expand to <code>-Dbar -Dfoo</code>.</p><p>Note that creating projections is very cheap. Notably, it is independent of the size of the set.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="projections-using-transitive-sets-in-write_json">Projections: using transitive sets in write_json()<a href="#projections-using-transitive-sets-in-write_json" class="hash-link" aria-label="Direct link to Projections: using transitive sets in write_json()" title="Direct link to Projections: using transitive sets in write_json()">​</a></h2><p>As with command lines, sets can form json projections to be used in write_json.</p><p>A json projection is defined in the same way as an arg projection. The function should return a value that <code>write_json</code> otherwise supports. Then, you call <code>project_as_json</code> to turn a set into a value that can be passed to <code>write_json</code> (or can appear within the value passed to it, it doesn&#x27;t need to be the top-level value). When expanded, the projection will expand like a list of all the node&#x27;s individual projected values.</p><p>Following is an example:</p><div class="language-starlark codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-starlark codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Declare the projection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def project_as_json(value: str.type):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return struct(key = &quot;foo&quot;, value = value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add it to the set definition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySet = transitive_set(json_projections = { &quot;define&quot;: project_as_json })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Create a set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set1 = ctx.actions.tset(MySet, value = &quot;foo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set2 = ctx.actions.tset(MySet, value = &quot;bar&quot;, children = [set1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Call the projection.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Note &quot;define&quot; is the key we used above in `json_projections`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">args = set2.project_as_json(&quot;define&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that if your projected values include (or may include) artifacts, you will likely want to use <code>write_json(with_inputs=True)</code> to get back a cmd_args that has all the artifacts in the json structure already in its <code>.hidden</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="traversals-in-depth">Traversals in depth<a href="#traversals-in-depth" class="hash-link" aria-label="Direct link to Traversals in depth" title="Direct link to Traversals in depth">​</a></h3><p>Transitive sets form DAGs. Notably, this means individual nodes can exist more than once in a given transitive set.</p><p>When a transitive set is traversed, nodes that have already been visited are skipped. This means their arguments will only be emitted once.</p><p>For example:</p><div class="mermaid">
flowchart TD
  foo((foo))
  bar((bar))
  qux((qux))
  qux --&gt; foo
  bar --&gt; foo
  qux --&gt; bar
</div><div class="language-starlark codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-starlark codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set1 = ctx.actions.tset(MySet, value = &quot;foo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set2 = ctx.actions.tset(MySet, value = &quot;bar&quot;, children = [set1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set3 = ctx.actions.tset(MySet, value = &quot;qux&quot;, children = [set1, set2])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">args = set3.project_as_args(&quot;define&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will expand to <code>-Dqux -Dfoo -Dbar</code>, even though <code>set1</code> (<code>&quot;foo&quot;</code>) shows up twice in the DAG.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-apis">Other APIs<a href="#other-apis" class="hash-link" aria-label="Direct link to Other APIs" title="Direct link to Other APIs">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transitive-set-reductions">Transitive set reductions<a href="#transitive-set-reductions" class="hash-link" aria-label="Direct link to Transitive set reductions" title="Direct link to Transitive set reductions">​</a></h3><p>You can aggregate values of a transitive set via a reduction. This can be helpful for tasks such as propagating Boolean flags up the tree.</p><p>Following is a real-world example.</p><p>When defining a reduction, you receive the reduced values of all your children, and an optional value for the current node (the value will be <code>None</code> when you create a set and you don&#x27;t pass a <code>value</code>), and you need to merge them together to produce this node&#x27;s value:</p><div class="language-starlark codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-starlark codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">def link_info_has_default_filelist(children: [&quot;bool&quot;], infos: [&quot;LinkInfos&quot;, None]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if infos:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info = infos.default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if info.filelist:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return any(children)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Set of LinkInfos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LinkInfosTSet = transitive_set(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reductions = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;has_default_filelist&quot;: link_info_has_default_filelist,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transitive-set-iteration">Transitive set iteration<a href="#transitive-set-iteration" class="hash-link" aria-label="Direct link to Transitive set iteration" title="Direct link to Transitive set iteration">​</a></h3><p>You <em>can</em> iterate over a transitive set. This will yield each value once. You can also iterate over projections.</p><p>However, note that this is generally not recommended, since unlike creating and using a projection, this operation is <code>O(set)</code>.</p><p>You should use this as an escape hatch if and only if you need to implement something transitive sets don&#x27;t support via projections or reductions, because in doing so you&#x27;ll lose a lot of the performance benefits.</p><p>For example:</p><div class="language-starlark codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-starlark codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set1 = ctx.actions.tset(MySet, value = &quot;foo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set2 = ctx.actions.tset(MySet, value = &quot;bar&quot;, children = [set1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set3 = ctx.actions.tset(MySet, value = &quot;qux&quot;, children = [set1, set2])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">values = list(set3.traverse())</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will yield <code>[&quot;qux&quot;, &quot;foo&quot;, &quot;bar&quot;]</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ordering">Ordering<a href="#ordering" class="hash-link" aria-label="Direct link to Ordering" title="Direct link to Ordering">​</a></h3><p>Transitive set iteration uses a left-to-right, pre-order traversal by default, and ignores nodes that have already been visited. This order is reflected in projections as well.</p><p>A few different traversal orders are supported with the <code>ordering</code> attribute:</p><table><thead><tr><th>Ordering</th><th>Description</th></tr></thead><tbody><tr><td><code>preorder</code> (default)</td><td>Traverses using a depth-first-search, visiting nodes left-to-right.</td></tr><tr><td><code>postorder</code></td><td>Traverses children left-to-right, and then visits the current node.</td></tr><tr><td><code>topological</code></td><td>A Topological sort, such that nodes are listed after all nodes that have them as descendants. This is similar to a pre-order traversal, except that when nodes are shared with more than one parent it is returned in the order of its last occurrence.</td></tr><tr><td><code>bfs</code></td><td>Breadth-first-search (BFS) traversal, traverses nodes left-to-right before traversing children.</td></tr></tbody></table><p>For example:</p><div class="language-starlark codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-starlark codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set1 = ctx.actions.tset(MySet, value = &quot;foo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set2 = ctx.actions.tset(MySet, value = &quot;bar&quot;, children = [set1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set3 = ctx.actions.tset(MySet, value = &quot;qux&quot;, children = [set1, set2])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">values = list(set3.traverse(ordering = &quot;topological&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This also works for projections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">args = set3.project_as_args(&quot;project&quot;, ordering = &quot;topological&quot;))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Following is an example of how different orderings evaluate:</p><div class="mermaid">
flowchart TD
  foo((foo))
  bar((bar))
  qux((qux))
  qux --&gt; foo
  bar --&gt; foo
  qux --&gt; bar
</div><table><thead><tr><th>Ordering</th><th>Result</th></tr></thead><tbody><tr><td><code>preorder</code></td><td><code>[&quot;qux&quot;, &quot;foo&quot;, &quot;bar&quot;]</code></td></tr><tr><td><code>postorder</code></td><td><code>[&quot;foo&quot;, &quot;bar&quot;, &quot;qux&quot;]</code></td></tr><tr><td><code>topological</code></td><td><code>[&quot;qux&quot;, &quot;bar&quot;, &quot;foo&quot;]</code></td></tr><tr><td><code>bfs</code></td><td><code>[&quot;qux&quot;, &quot;foo&quot;, &quot;bar&quot;]</code></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-details">Implementation details<a href="#implementation-details" class="hash-link" aria-label="Direct link to Implementation details" title="Direct link to Implementation details">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="projection-evaluation">Projection evaluation<a href="#projection-evaluation" class="hash-link" aria-label="Direct link to Projection evaluation" title="Direct link to Projection evaluation">​</a></h3><p>Projections are evaluated eagerly for each node of your transitive set. This means that if your projection throws an error, you&#x27;ll find out when creating a set via <code>ctx.actions.tset</code>.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/rule_authors/rule_api/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Rule APIs</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/rule_authors/configurations/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Configurations</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#rule-api" class="table-of-contents__link toc-highlight">Rule API</a></li><li><a href="#projections-using-transitive-sets-in-command-lines" class="table-of-contents__link toc-highlight">Projections: using transitive sets in command lines</a></li><li><a href="#projections-using-transitive-sets-in-write_json" class="table-of-contents__link toc-highlight">Projections: using transitive sets in write_json()</a><ul><li><a href="#traversals-in-depth" class="table-of-contents__link toc-highlight">Traversals in depth</a></li></ul></li><li><a href="#other-apis" class="table-of-contents__link toc-highlight">Other APIs</a><ul><li><a href="#transitive-set-reductions" class="table-of-contents__link toc-highlight">Transitive set reductions</a></li><li><a href="#transitive-set-iteration" class="table-of-contents__link toc-highlight">Transitive set iteration</a></li><li><a href="#ordering" class="table-of-contents__link toc-highlight">Ordering</a></li></ul></li><li><a href="#implementation-details" class="table-of-contents__link toc-highlight">Implementation details</a><ul><li><a href="#projection-evaluation" class="table-of-contents__link toc-highlight">Projection evaluation</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">User guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e94ab9dd.js"></script>
<script src="/assets/js/main.71de8834.js"></script>
</body>
</html>