"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[6986],{3905:(e,t,n)=>{n.r(t),n.d(t,{MDXContext:()=>d,MDXProvider:()=>c,mdx:()=>g,useMDXComponents:()=>p,withMDXComponents:()=>u});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(){return r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},r.apply(this,arguments)}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var d=a.createContext({}),u=function(e){return function(t){var n=p(t.components);return a.createElement(e,r({},t,{components:n}))}},p=function(e){var t=a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(d.Provider,{value:t},e.children)},h="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},f=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=p(n),c=i,h=u["".concat(o,".").concat(c)]||u[c]||m[c]||r;return n?a.createElement(h,s(s({ref:t},d),{},{components:n})):a.createElement(h,s({ref:t},d))}));function g(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=f;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[h]="string"==typeof e?e:i,o[1]=s;for(var d=2;d<r;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}f.displayName="MDXCreateElement"},87280:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var a=n(87462),i=(n(67294),n(3905));const r={id:"dep_files",title:"Dep Files"},o=void 0,s={unversionedId:"rule_authors/dep_files",id:"rule_authors/dep_files",title:"Dep Files",description:"Dep files allow commands to declare which subset of their inputs were used when the command executed.",source:"@site/../docs/rule_authors/dep_files.md",sourceDirName:"rule_authors",slug:"/rule_authors/dep_files",permalink:"/docs/rule_authors/dep_files",draft:!1,tags:[],version:"current",frontMatter:{id:"dep_files",title:"Dep Files"},sidebar:"manualSidebar",previous:{title:"Local Resources For Tests Execution",permalink:"/docs/rule_authors/local_resources"},next:{title:"Why BXL",permalink:"/docs/developers/bxl"}},l={},d=[{value:"Use Cases",id:"use-cases",level:2},{value:"Using dep files",id:"using-dep-files",level:2},{value:"Declaring the dep files and associating inputs",id:"declaring-the-dep-files-and-associating-inputs",level:2},{value:"Producing the dep file",id:"producing-the-dep-file",level:2},{value:"Testing dep files",id:"testing-dep-files",level:2},{value:"Extra notes to the implementer",id:"extra-notes-to-the-implementer",level:2},{value:"Limitations",id:"limitations",level:3},{value:"Dep files don&#39;t need to be covering",id:"dep-files-dont-need-to-be-covering",level:3},{value:"Dep files are lazy",id:"dep-files-are-lazy",level:3},{value:"Dep files will traverse symlinks",id:"dep-files-will-traverse-symlinks",level:2}],u={toc:d};function p(e){let{components:t,...n}=e;return(0,i.mdx)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.mdx)("p",null,"Dep files allow commands to declare which subset of their inputs were used when the command executed."),(0,i.mdx)("p",null,"When a command produces a dep file and is later invalidated due to an inputs change, Buck2 uses the dep file to check whether the inputs that changed were in the set that the command reported as having used. If none of the inputs that changed were in that set, Buck2 omits re-running the command and reuses the previous result."),(0,i.mdx)("h2",{id:"use-cases"},"Use Cases"),(0,i.mdx)("p",null,"Dep files are used to make dependencies finer grained than what exists in the target graph, but they're not a substitute for avoiding unused dependencies. They're often useful when targets export many outputs (such as C++ headers) that aren't all used by all their dependents."),(0,i.mdx)("p",null,"Dep files are currently used to skip recompilation steps in C++ when an unused header changed. They're also used in Java to skip recompilation when an unused class changed."),(0,i.mdx)("h2",{id:"using-dep-files"},"Using dep files"),(0,i.mdx)("p",null,"To use dep files, you need to do the following:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"Declare what output is a dep file and associate it with your command."),(0,i.mdx)("li",{parentName:"ul"},"Declare which inputs are covered by the dep file (this can be a subset of your inputs)."),(0,i.mdx)("li",{parentName:"ul"},"Have your command produce the dep file in a format Buck2 can use.")),(0,i.mdx)("p",null,"You must also enable ",(0,i.mdx)("a",{parentName:"p",href:"/docs/users/advanced/deferred_materialization"},"Deferred Materialization")," to use dep files."),(0,i.mdx)("h2",{id:"declaring-the-dep-files-and-associating-inputs"},"Declaring the dep files and associating inputs"),(0,i.mdx)("p",null,"To declare a dep file and associate it with your command, you need to tag your artifacts."),(0,i.mdx)("p",null,"Specifically, you'll tag the output (the dep file) and the inputs it covers, as shown in the following code:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},'# First, create a tag\n\nheaders_tag = ctx.actions.artifact_tag()\n\n# Then, tag inputs and the dep file itself in your command line.\n# You do this using the `tag_artifacts` method on your tag.\n# This method does not mutate the input, it wraps it, so you use the output.\n# Any command-line-arg-like can be tagged.\n\ntagged_headers = headers_tag.tag_artifacts(headers)\n\ndep_file = ctx.actions.declare_output("deps").as_output()\ntagged_dep_file = headers_tag.tag_artifacts(dep_file)\n\n# Finally, declare your action.\n# Use the tagged artifacts as you would regular command-line-arg-likes.\n# Pass the tag in `dep_files` and give a name (this is used for logging).\n\nctx.actions.run(\n  ["mycc", "-I", tagged_headers, "-MD", "-MF", tagged_dep_file, "-o", ...],\n  dep_files = { "headers": headers_tag }\n)\n\n')),(0,i.mdx)("h2",{id:"producing-the-dep-file"},"Producing the dep file"),(0,i.mdx)("p",null,"Your command must produce dep files in the format Buck2 expects, which is simply a list of all the inputs that were used, one per line."),(0,i.mdx)("p",null,"The paths must be the paths Buck2 would use for your inputs, which means paths relative to the project root."),(0,i.mdx)("p",null,"If this is not the format your tool produces, use a wrapper to take whatever output your command produces and rewrite it in the format Buck2 expects."),(0,i.mdx)("h2",{id:"testing-dep-files"},"Testing dep files"),(0,i.mdx)("p",null,"When writing a command that produces a dep file, you should test it! At a minimum, check that the inputs you expect are tagged properly."),(0,i.mdx)("p",null,"To do so, build your target, then use ",(0,i.mdx)("inlineCode",{parentName:"p"},"buck2 audit dep-files TARGET CATEGORY IDENTIFIER"),", which will show you the set of inputs your command used and how they're tagged."),(0,i.mdx)("h2",{id:"extra-notes-to-the-implementer"},"Extra notes to the implementer"),(0,i.mdx)("h3",{id:"limitations"},"Limitations"),(0,i.mdx)("p",null,"Dep files only work if a previous invocation of the command is known to your Buck2 daemon. Dep files are dropped when the daemon restarts or when you run ",(0,i.mdx)("inlineCode",{parentName:"p"},"buck2 debug flush-dep-files"),"."),(0,i.mdx)("p",null,"This means that, for example, if you change an unused header, then run a build on a fresh daemon, Buck2 will still need to execute this command in order to identify that the header was in fact unused. In contrast, if you did the build (and got a remote cache hit on the command), then applied your change and re-built, Buck2 would use the dep file on the second execution, and you wouldn't need to execute anything."),(0,i.mdx)("h3",{id:"dep-files-dont-need-to-be-covering"},"Dep files don't need to be covering"),(0,i.mdx)("p",null,"It's OK for the dep file to only cover a subset of the inputs of your action. However, within that subset, the dep file must declare all the inputs that were used."),(0,i.mdx)("p",null,"If you fail to report some inputs you used, then your command will not re-run when they change, and you'll get stale output."),(0,i.mdx)("h3",{id:"dep-files-are-lazy"},"Dep files are lazy"),(0,i.mdx)("p",null,"Dep files aren't parsed by Buck2 unless the command needs to re-run. If the command ran on RE, they aren't even downloaded until then. This ensures dep files don't cause a performance hit unless they are used, at which point they stand a chance of giving a performance boost instead."),(0,i.mdx)("p",null,"This means that if you produce an invalid dep file, Buck2 will not report this until your command runs again, at which point Buck2 will report that the dep file is invalid and refuse to proceed (note: you can unblock yourself using ",(0,i.mdx)("inlineCode",{parentName:"p"},"buck2 debug flush-dep-files"),")."),(0,i.mdx)("p",null,"To flush out issues during development, you can pass ",(0,i.mdx)("inlineCode",{parentName:"p"},"--eager-dep-files")," to Buck2 to force Buck2 to parse your dep files as they are produced."),(0,i.mdx)("h2",{id:"dep-files-will-traverse-symlinks"},"Dep files will traverse symlinks"),(0,i.mdx)("p",null,"If your dep file reports that a symlink was used, Buck2 will track the symlink's target as covered by this dep file."))}p.isMDXComponent=!0}}]);