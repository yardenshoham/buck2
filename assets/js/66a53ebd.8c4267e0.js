"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9972],{3905:(e,t,n)=>{n.r(t),n.d(t,{MDXContext:()=>p,MDXProvider:()=>d,mdx:()=>v,useMDXComponents:()=>c,withMDXComponents:()=>m});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(){return i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},i.apply(this,arguments)}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),m=function(e){return function(t){var n=c(t.components);return r.createElement(e,i({},t,{components:n}))}},c=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=c(e.components);return r.createElement(p.Provider,{value:t},e.children)},u="mdxType",f={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},g=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=c(n),d=a,u=m["".concat(o,".").concat(d)]||m[d]||f[d]||i;return n?r.createElement(u,l(l({ref:t},p),{},{components:n})):r.createElement(u,l({ref:t},p))}));function v(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=g;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}g.displayName="MDXCreateElement"},60787:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var r=n(87462),a=(n(67294),n(3905));const i={id:"parity_script",title:"Parity Testing"},o=void 0,l={unversionedId:"developers/parity_script",id:"developers/parity_script",title:"Parity Testing",description:"This page covers the parity testing/command replay script found in scripts/buck_replay/main.py.",source:"@site/../docs/developers/parity_script.md",sourceDirName:"developers",slug:"/developers/parity_script",permalink:"/docs/developers/parity_script",draft:!1,tags:[],version:"current",frontMatter:{id:"parity_script",title:"Parity Testing"},sidebar:"manualSidebar",previous:{title:"Buck1 vs Buck2",permalink:"/docs/developers/architecture/buck1_vs_buck2"},next:{title:"Finding Commands That Buck2 Ran",permalink:"/docs/developers/what-ran"}},s={},p=[{value:"Overview",id:"overview",level:2},{value:"Flags",id:"flags",level:2},{value:"Running the script",id:"running-the-script",level:2},{value:"Development",id:"development",level:2}],m={toc:p};function c(e){let{components:t,...n}=e;return(0,a.mdx)("wrapper",(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,a.mdx)("p",null,"This page covers the parity testing/command replay script found in ",(0,a.mdx)("inlineCode",{parentName:"p"},"scripts/buck_replay/main.py"),"."),(0,a.mdx)("h2",{id:"overview"},"Overview"),(0,a.mdx)("p",null,"The ",(0,a.mdx)("inlineCode",{parentName:"p"},"buck_replay")," script is meant to test parity between v1 and v2 implementations of commands by querying for logs of the repo and execution state (args, directory) of v2 command invocations, reproducing it locally, making the necessary conversions from v2 to v1 args, and then running both versions of the command so output can be checked/compared."),(0,a.mdx)("p",null,"When output differs/parity testing fails, the results are logged into a Scuba table for future reference/analysis."),(0,a.mdx)("h2",{id:"flags"},"Flags"),(0,a.mdx)("p",null,"The following is a list of arguments/flags currently supported by the list:"),(0,a.mdx)("ul",null,(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"--verbose")," - supplying this turns on debug logging. By default, the replay script logs updates on script progress and any errors that happen. When ",(0,a.mdx)("inlineCode",{parentName:"li"},"--verbose")," is given, debug logging will also provide updates on commit and directory changes while parity testing."),(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"--dry-run")," - toggles logging to a test Scuba table instead of the production one. Useful if you're making edits/testing the script itself."),(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"--epoch")," - the time after which to query Scuba for logs of commands for, as a Unix timestamp. If not supplied, it defaults to the last 24 hours."),(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"--limit")," - limits the number of rows queried from Scuba. The default limit is 100000 rows.")),(0,a.mdx)("h2",{id:"running-the-script"},"Running the script"),(0,a.mdx)("p",null,"The script can be run with buck:"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre",className:"language-shell"},"buck run //buck2/scripts/buck_replay:buck_replay\n")),(0,a.mdx)("p",null,"Example with flags:"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre",className:"language-shell"},"buck run //buck2/scripts/buck_replay:buck_replay -- --verbose --dry-run --epoch 1626739329 --limit 100000\n")),(0,a.mdx)("h2",{id:"development"},"Development"),(0,a.mdx)("p",null,"The script does not yet support commands beyond ",(0,a.mdx)("inlineCode",{parentName:"p"},"audit config"),". Because of differences in flags (different names, new/dropped flags, and so on) in v1 and v2 implementations of commands, there needs to be some conversion when going from one set of arguments to the other. As such, support for a command requires the implementation of a ",(0,a.mdx)("inlineCode",{parentName:"p"},"Command")," class for that command, and with it, several methods:"),(0,a.mdx)("ul",null,(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"format_common_args"),", ",(0,a.mdx)("inlineCode",{parentName:"li"},"format_args_v1"),", ",(0,a.mdx)("inlineCode",{parentName:"li"},"format_args_v2")," - to format the flags/arguments in common between the v1 and v2 versions of a command as well as the ones specific to v1 and v2, respectively."),(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"run_v1")," and ",(0,a.mdx)("inlineCode",{parentName:"li"},"run_v2")," - meant to run the v1 and v2 commands and capture the relevant output."),(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"test_parity"),' - meant to compare the output the v1 and v2 outputs (note that the standard for what\'s "equal" may change between commands) and log whatever is necessary.')),(0,a.mdx)("p",null,"You can also work on features surrounding the replay script; specifically, adding logging to more commands (since in v2 only ",(0,a.mdx)("inlineCode",{parentName:"p"},"audit config")," logging is supported) and Ingress tailer support (currently command logging is handled by ",(0,a.mdx)("inlineCode",{parentName:"p"},"CommandReporterProcessor"),")."))}c.isMDXComponent=!0}}]);